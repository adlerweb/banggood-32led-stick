#include <stc12.h>

#define GRAPHSIZE 16

const unsigned long graph[GRAPHSIZE] = {
	0b00000000001111111111110000000000,
	0b00000011111111111111111111000000,
	0b00001111111111111111111111110000,
	0b00111111100001111111111111111100,
	0b00111110011111111111111111111100,
	0b11111001111111111110000000011111,
	0b11111001111111111111111111111111,
	0b11111001111111111111111111111111,
	0b11111001111111111111111111111111,
	0b11111001111111111111111111111111,
	0b11111001111111111110000000011111,
	0b00111111001111111111111111111100,
	0b00111111110000111111111111111100,
	0b00001111111111111111111111110000,
	0b00000011111111111111111111000000,
	0b00000000001111111111110000000000
};

/*const unsigned long graph[GRAPHSIZE] = {
	0b00111111111111111111111111111100,
	0b00111100000000111100000000111100,
	0b00111100000000111100000000111100,
	0b00111100000000111100000000111100,
	0b00000011111111000011111111000000,
	0b00000000000000000000000000000000,
	0b00111100000000000000000000111100,
	0b00111100000000000000000000111100,
	0b00111111111111111111111111111100,
	0b00111100000000000000000000111100,
	0b00111100000000000000000000111100,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000111100,
	0b00000000000000000000000000111100,
	0b00111111111111111111111111111100,
	0b00000000000000000000000000111100,
	0b00000000000000000000000000111100,
	0b00000000000000000000000000000000,
	0b00111111111111111111111111111100,
	0b00111100000000111100000000111100,
	0b00111100000000111100000000111100,
	0b00111100000000111100000000111100,
	0b00000011111111000011111111000000,
	0b00000000000000000000000000000000,
	0b00111111111111111100000000000000,
	0b00000000011110000011111111000000,
	0b00000000011110000000000000111100,
	0b00000000011110000011111111000000,
	0b00111111111111111100000000000000,
	0b00000000000000000000000000000000,
	0b00000011110000000011111111000000,
	0b00111100000000111100000000111100,
	0b00111100000000111100000000111100,
	0b00111100000000111100000000111100,
	0b00000011111111000000001111000000,
	0b00000000000000000000000000000000,
	0b00000000000000000000000000111100,
	0b00000000000000000000000000111100,
	0b00111111111111111111111111111100,
	0b00000000000000000000000000111100,
	0b00000000000000000000000000111100,
	0b00000000000000000000000000000000,
	0b00111111111111111111111111111100,
	0b00111100000000111110000000111100,
	0b00111100000000111110000000111100,
	0b00111100000000111110000000111100,
	0b00111100000000000000000000111100,
	0b00000000000000000000000000000000,
	0b00111111111111111111111111111000,
	0b00111100000000000000000000000000,
	0b00111100000000000000000000000000,
	0b00111100000000000000000000000000,
	0b00111100000000000000000000000000,
	0b00000000000000000000000000000000,
	0b00111111111111111111111111111100,
	0b00111100000000111100000000111100,
	0b00111100000000111100000000111100,
	0b00111100000000111100000000111100,
	0b00111100000000000000000000111100,
	0b00000000000000000000000000000000,
	0b00111100000000000000000000111100,
	0b00111100000000000000000000111100,
	0b00111111111111111111111111111100,
	0b00111100000000000000000000111100,
	0b00111100000000000000000000111100
};*/


void setTristate(unsigned char port, unsigned char pos, signed char state) {
	switch(port) {
		case 1:
			if(state > 0) {			/* //HIGH */
				P1   &= ~(1<<pos);
				P1M1 &= ~(1<<pos);
				P1M0 |= (1<<pos);
			}else if(state < 0) {	/* //LOW */
				P1   |= (1<<pos);
				P1M1 &= ~(1<<pos);
				P1M0 |= (1<<pos);
			}else{					/* //High-Z */
				P1M1 |= (1<<pos);
				P1M0 &= ~(1<<pos);
				P1   |= (1<<pos);
			}
			break;
		case 3:
			if(state > 0) {			/* //HIGH */
				P3   &= ~(1<<pos);
				P3M1 &= ~(1<<pos);
				P3M0 |= (1<<pos);
			}else if(state < 0) {	/* //LOW */
				P3   |= (1<<pos);
				P3M1 &= ~(1<<pos);
				P3M0 |= (1<<pos);
			}else{					/* //High-Z */
				P3M1 |= (1<<pos);
				P3M0 &= ~(1<<pos);
				P3   |= (1<<pos);
			}
			break;
	}
}

void setBlankX(void) {
	setTristate(3, 0, 0);
	setTristate(3, 1, 0);
	setTristate(3, 3, 0);
	setTristate(3, 4, 0);
}

void setBlankY(void) {
	setTristate(1, 0, 0);
	setTristate(1, 2, 0);
	setTristate(1, 4, 0);
	setTristate(1, 6, 0);
}

void setBlank(void) {
	setBlankX();
	setBlankY();
}

void setColumn(unsigned char col) { /* ~10ms per run */
	unsigned char lx = 0;
	unsigned char ly = 0;
	unsigned char lz = 0;
	unsigned char x = 0;
	unsigned char y = 0;
	unsigned long line = graph[col];

	for(lx=0; lx<4; lx++) {
		switch(lx) {
			case 0: x=0; break;
			case 1: x=1; break;
			case 2: x=3; break;
			case 3: x=4; break;
		}
		for(ly=0; ly<4; ly++) {
			setBlankX();
			switch(ly) {
				case 0: y=0; break;
				case 1: y=2; break;
				case 2: y=4; break;
				case 3: y=6; break;
			}

			for(lz=0; lz<=1; lz++) {
				setBlankY();
				switch(lz) {
					case 0:
						if(line & 1) {
							setTristate(1, y, 1);
							setTristate(3, x, -1);
						}else{
							setTristate(1, y, 0);
							setTristate(3, x, 0);
						}
						break;
					case 1:
						if(line & 1) {
							setTristate(1, y, -1);
							setTristate(3, x, 1);
						}else{
							setTristate(1, y, 0);
							setTristate(3, x, 0);
						}
						break;
				}

				line >>= 1;
			}
		}
	}
}

void main(void) {
	unsigned char col = 0;
	unsigned char i = 0;

	unsigned char timer = 1;

	P0M1 = 0xFF;
	P0M0 = 0x00;
	P1M1 = 0xFF;
	P1M0 = 0x00;
	P2M1 = 0xFF;
	P2M0 = 0x00;
	P3M1 = 0b1011011; /* //3+5 = Switch */
	P3M0 = 0b0000000; /* //3+5 = Switch */
	P4M1 = 0xFF;
	P4M0 = 0x00;

	P0=0x00;
	P1=0x00;
	P2=0x00;
	P3=0b00100100; /* //Pull-Up for switches */
	P4=0x00;

	while(1) {
		if((P3_5 == 0)) {
			for(i=0; i<timer; i++) setColumn(col);
			if(col < GRAPHSIZE) col++;
		}else{
			setBlank();
			if(col > GRAPHSIZE) timer++;
			if(col < GRAPHSIZE) timer--;
			col=0;
		}
    	}
}